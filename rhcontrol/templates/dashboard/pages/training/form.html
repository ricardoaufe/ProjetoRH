{% extends 'global/base.html' %}

{% block title %} Registrar Treinamento | {% endblock title %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">

<div class="form-container">
    <h2>{{ title|default:"Registrar Treinamento" }}</h2>

    <form method="POST" id="trainingForm">
        {% csrf_token %}

        <div class="form-content">  
            {% include 'partials/form_field.html' with field=form.training_name label="Nome do Treinamento" %}
            {% include 'partials/form_field.html' with field=form.training_date label="Data do Treinamento" %}
            {% include 'partials/form_field.html' with field=form.training_provider label="Fornecedor" %}
            {% include 'partials/form_field.html' with field=form.training_duration label="Duração (horas)" %}
            
            <div style="grid-column: 1 / -1;">
                {% include 'partials/form_field.html' with field=form.training_description label="Descrição" %}
            </div>
        </div>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            
            <div style="height:100px; width:350px; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #e9ecef; margin-bottom: 20px;">
                {% include 'partials/form_field.html' with field=form.is_fundamental label="É Treinamento Fundamental?" %}
            </div>

            <div id="div_target_department" class="hidden conditional-box">
                <h4 style="margin-top: 0; color: #495057;">Configuração de Setor</h4>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Todos os funcionários ativos deste setor serão inscritos automaticamente.
                </p>
                
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        {% include 'partials/form_field.html' with field=form.target_department label="Selecione o Setor" %}
                    </div>
                    <div style="padding-top: 15px;">
                        {% include 'partials/form_field.html' with field=form.all_departments %}
                    </div>
                </div>
            </div>

            <div id="div_scheduled_employees">
                <h4 style="margin-top: 0; font-size: 1.6rem; color: #495057;">Seleção de Participantes</h4>
                <p style="font-size: 1.4rem; color: #666; margin-bottom: 10px;">
                    Pesquise pelo nome e pressione Enter para adicionar.
                </p>
                {% include 'partials/form_field.html' with field=form.scheduled_employees %}

                {% if form.instance.pk %}
                    <hr style="margin: 30px 0;">
                    
                    <h4 style="margin-top: 0; font-size: 1.6rem; color: #28a745;">Confirmação de Presença</h4>
                    <p style="font-size: 1.6rem; color: #666; margin-bottom: 10px;">
                        Destes previstos, quem realmente veio?
                    </p>
                    {% include 'partials/form_field.html' with field=form.attended_employees %}
                {% endif %}
            </div>

        </div>

        <div class="form-actions">
            <button type="submit" class="btn-save">Salvar Treinamento</button>

            {% if form.instance.pk %}
                <a href="{% url 'rhcontrol:training_delete' pk=form.instance.pk %}" class="btn-delete">
                    <i class="fa fa-trash"></i> Excluir Treinamento
                </a>
            {% endif %}
        
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        if(document.getElementById('id_scheduled_employees')) {
            new TomSelect("#id_scheduled_employees", {
                plugins: ['remove_button'], // 'X' to remove
                create: false,              // Just selection from existing options
                sortField: {
                    field: "text",
                    direction: "asc"
                },
                placeholder: "Digite o nome do funcionário...",
                maxOptions: null            // All options shown
            });
        }

        if(document.getElementById('id_attended_employees')) {
            new TomSelect("#id_attended_employees", {
                plugins: ['remove_button'],
                create: false, 
                sortField: { field: "text", direction: "asc" },
                placeholder: "Selecione quem realmente compareceu...",
                maxOptions: null
            });
        }

        const checkFundamental = document.getElementById('id_is_fundamental');
        const checkAllDepts = document.getElementById('id_all_departments');
        const containerSetor = document.getElementById('div_target_department');
        const containerManual = document.getElementById('div_scheduled_employees');
        const selectTargetDept = document.getElementById('id_target_department');
        
        function toggleFields() {
            if (checkFundamental && checkFundamental.checked) {
                if(containerSetor) containerSetor.classList.remove('hidden');
                if(containerManual) containerManual.classList.add('hidden');
                
                if (checkAllDepts && checkAllDepts.checked) {
                    if(selectTargetDept) {
                        selectTargetDept.disabled = true;
                        selectTargetDept.value = "";
                    }
                } else {
                    if(selectTargetDept) selectTargetDept.disabled = false;
                }
            } else {
                if(containerSetor) containerSetor.classList.add('hidden');
                if(containerManual) containerManual.classList.remove('hidden');
            }
        }

        if (checkFundamental) checkFundamental.addEventListener('change', toggleFields);
        if (checkAllDepts) checkAllDepts.addEventListener('change', toggleFields);
        
        toggleFields();
    });
</script>

{% endblock content %}