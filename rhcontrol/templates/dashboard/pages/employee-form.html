{% extends 'global/base.html' %}

{% block title %} Registar Funcionário | {% endblock title %}

{% block content %}
    <div class="form-container">
        <h2>Cadastrar Funcionário</h2>

        <form method="POST" id="employeeForm" data-jobs-url="{% url 'ajax_load_job_titles' %}">
            {% csrf_token %}
            
            <div class="form-content">
                {% for field in form %}
                    <div class="form-group">
                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="message error">
                                {{ field.errors }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <button type="submit">Salvar</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vamos adicionar um teste para você ver no console se o script carregou
            console.log("Script de Funcionário Carregado!"); 

            const departmentSelect = document.getElementById('id_department');
            const jobTitleSelect = document.getElementById('id_job_title');
            const salaryInput = document.getElementById('id_current_salary');
            const formElement = document.getElementById('employeeForm');

            // Proteção caso o JS não encontre o formulário
            if (!formElement) {
                console.error("Erro: Formulário não encontrado.");
                return;
            }

            const url = formElement.getAttribute('data-jobs-url');

            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                console.log("Setor alterado para ID:", departmentId); // Debug

                salaryInput.value = '';

                if (!departmentId) {
                    jobTitleSelect.innerHTML = '<option value="">---------</option>';
                    return;
                }

                fetch(`${url}?department_id=${departmentId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Erro na requisição AJAX");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Cargos recebidos:", data); // Debug
                        jobTitleSelect.innerHTML = '<option value="">---------</option>';
                        
                        data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = job.name;
                            
                            // Tenta pegar 'base_salary' (novo) ou 'salary' (antigo)
                            const salario = job.base_salary ? job.base_salary : (job.salary ? job.salary : '');
                            option.setAttribute('data-salary', salario);
                            
                            jobTitleSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro:', error));
            });

            jobTitleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const baseSalary = selectedOption.getAttribute('data-salary');
                
                console.log("Cargo selecionado. Salário base:", baseSalary); // Debug

                if (baseSalary) {
                    salaryInput.value = baseSalary;
                } else {
                    salaryInput.value = '';
                }
            });
        });
    </script>

{% endblock %} 
