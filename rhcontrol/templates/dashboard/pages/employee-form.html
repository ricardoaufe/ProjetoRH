{% extends 'global/base.html' %}

{% block title %} Cadastrar Funcion√°rio | {% endblock title %}

{% block content %}

<div class="form-container">
    <h2>{{ title|default:"Cadastrar Funcion√°rio" }}</h2>

    <form method="POST" id="employeeForm" data-jobs-url="{% url 'ajax_load_job_titles' %}">
        {% csrf_token %}
        
        <div class="form-content">
            
            <h3 class="section-title">Dados Pessoais</h3>
            
            {% include 'partials/form_field.html' with field=form.name %}
            {% include 'partials/form_field.html' with field=form.birth_date %}
            
            {% include 'partials/form_field.html' with field=form.gender %}
            {% include 'partials/form_field.html' with field=form.ethnicity %}
            
            {% include 'partials/form_field.html' with field=form.marital_status %}
            {% include 'partials/form_field.html' with field=form.education_level %}
            
            {% include 'partials/form_field.html' with field=form.mother_name %}
            <div class="form-group"></div> {% include 'partials/form_field.html' with field=form.birth_city %}
            {% include 'partials/form_field.html' with field=form.state_birthplace_code %}


            <h3 class="section-title">Documenta√ß√£o</h3>

            {% include 'partials/form_field.html' with field=form.cpf %}
            {% include 'partials/form_field.html' with field=form.rg %}
            
            {% include 'partials/form_field.html' with field=form.rg_issue_date %}
            {% include 'partials/form_field.html' with field=form.pis %}
            
            {% include 'partials/form_field.html' with field=form.ctps_number %}
            {% include 'partials/form_field.html' with field=form.ctps_series %}
            
            {% include 'partials/form_field.html' with field=form.ctps_issue_date %}
            <div class="form-group"></div>


            <h3 class="section-title">Contato e Endere√ßo</h3>

            {% include 'partials/form_field.html' with field=form.email %}
            {% include 'partials/form_field.html' with field=form.mobile_phone %}

            {% include 'partials/form_field.html' with field=form.zip_code %}
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.address %}
            {% include 'partials/form_field.html' with field=form.address_num %}

            {% include 'partials/form_field.html' with field=form.complement %}
            {% include 'partials/form_field.html' with field=form.neighborhood %}

            {% include 'partials/form_field.html' with field=form.city %}
            {% include 'partials/form_field.html' with field=form.state_code %}

            {% include 'partials/form_field.html' with field=form.emergency_contact_name %}
            {% include 'partials/form_field.html' with field=form.emergency_phone %}


            <h3 class="section-title">Dados do Contrato</h3>

            {% include 'partials/form_field.html' with field=form.department %}
            {% include 'partials/form_field.html' with field=form.job_title %}

            {% include 'partials/form_field.html' with field=form.current_salary %}
            {% include 'partials/form_field.html' with field=form.hire_date %}

            {% include 'partials/form_field.html' with field=form.admission_exam_date %}
            <div class="form-group"></div>
            
            {% include 'partials/form_field.html' with field=form.is_trial_contract %}
            {% include 'partials/form_field.html' with field=form.is_first_job %}
            
            {% include 'partials/form_field.html' with field=form.is_intermittent_contract %}
            {% include 'partials/form_field.html' with field=form.uses_transport_voucher %}
            
            {% include 'partials/form_field.html' with field=form.has_insalubrity_bonus %}
            {% include 'partials/form_field.html' with field=form.has_danger_bonus %}


            <h3 class="section-title">Dados Banc√°rios</h3>

            {% include 'partials/form_field.html' with field=form.bank_name %}
            {% include 'partials/form_field.html' with field=form.account_type %}
            
            {% include 'partials/form_field.html' with field=form.bank_agency_code %}
            {% include 'partials/form_field.html' with field=form.account_num %}


            <h3 class="section-title">Informa√ß√µes de Estrangeiro</h3>
            
            {% include 'partials/form_field.html' with field=form.is_foreign %}
            <div class="form-group"></div>

            <div id="foreign-container" class="conditional-section hidden">
                {% include 'partials/form_field.html' with field=form.arrival_date %}
                {% include 'partials/form_field.html' with field=form.naturalization_date %}
                
                {% include 'partials/form_field.html' with field=form.rne_number %}
                {% include 'partials/form_field.html' with field=form.rne_issue_date %}
                
                {% include 'partials/form_field.html' with field=form.rne_issuing_authority %}
                <div class="form-group"></div>
                
                {% include 'partials/form_field.html' with field=form.married_to_brazilian %}
                {% include 'partials/form_field.html' with field=form.has_brazilian_children %}
            </div>


            <h3 class="section-title">Outras Informa√ß√µes</h3>

            {% include 'partials/form_field.html' with field=form.is_pcd %}
            
            <div id="pcd-container" class="conditional-section hidden" style="display: block; grid-column: span 1;">
                {% include 'partials/form_field.html' with field=form.disability_type %}
            </div>
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.retirement_status %}
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.is_cipa_member %}
            <div class="form-group"></div>

            <div id="cipa-container" class="conditional-section hidden">
                {% include 'partials/form_field.html' with field=form.cipa_role %}
                <div class="form-group"></div>
                
                {% include 'partials/form_field.html' with field=form.cipa_mandate_start_date %}
                {% include 'partials/form_field.html' with field=form.cipa_mandate_end_date %}
            </div>

            <h3 class="section-title">Desligamento</h3>
            {% include 'partials/form_field.html' with field=form.termination_date %}
            {% include 'partials/form_field.html' with field=form.termination_reason %}

        </div>

        <div class="form-buttons">
            <button type="submit" class="btn-save">Salvar Cadastro</button>

            {% if form.instance.pk %}
                <a href="{% url 'employee_delete' pk=form.instance.pk %}" class="btn-delete">
                    <i class="fa fa-trash"></i> Excluir Funcion√°rio
                </a>
            {% endif %}
        </div>
    </form>
</div>

{% if history_enabled %}
    <div class="history-section">
        <h3>Hist√≥rico do Colaborador</h3>
        
        <div >
            
            <div class="card" >
                <h4>üéì Treinamentos ({{ total_hours }} horas)</h4>
                <ul>
                    {% for t in trainings %}
                        <li><strong>{{ t.date|date:"d/m/Y" }}</strong> - {{ t.name }} ({{ t.duration }}h)</li>
                    {% empty %}
                        <li>Nenhum treinamento realizado.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card">
                <h4>üíº Evolu√ß√£o Profissional</h4>
                <ul>
                    {% for h in history_log %}
                        <li>
                            <small>{{ h.date_changed|date:"d/m/Y" }}</small><br>
                            {% if h.old_job_title %}
                                Cargo: {{ h.old_job_title }} ‚ûù <strong>{{ h.new_job_title }}</strong><br>
                            {% endif %}
                            {% if h.old_salary %}
                                Sal√°rio: R$ {{ h.old_salary }} ‚ûù <strong>R$ {{ h.new_salary }}</strong>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li>Nenhuma altera√ß√£o registrada.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card">
                <h4>üèñÔ∏è Hist√≥rico de F√©rias</h4>
                <ul>
                    {% for v in vacations %}
                        <li>{{ v.start_date|date:"d/m/Y" }} at√© {{ v.end_date|date:"d/m/Y" }} ({{ v.vacation_duration }} dias)</li>
                    {% empty %}
                        <li>Nenhuma f√©rias registrada.</li>
                    {% endfor %}
                </ul>
            </div>

        </div>
    </div>
{% endif %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Script carregado!");

        const departmentSelect = document.getElementById('id_department');
        const jobTitleSelect = document.getElementById('id_job_title');
        const salaryInput = document.getElementById('id_current_salary');
        const formElement = document.getElementById('employeeForm');

        if (formElement) {
            const url = formElement.getAttribute('data-jobs-url');

            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                salaryInput.value = '';

                if (!departmentId) {
                    jobTitleSelect.innerHTML = '<option value="">---------</option>';
                    return;
                }

                fetch(`${url}?department_id=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        jobTitleSelect.innerHTML = '<option value="">---------</option>';
                        data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = job.name;
                            const salario = job.base_salary ? job.base_salary : (job.salary ? job.salary : '');
                            option.setAttribute('data-salary', salario);
                            jobTitleSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro:', error));
            });

            jobTitleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const baseSalary = selectedOption.getAttribute('data-salary');
                if (baseSalary) {
                    salaryInput.value = baseSalary;
                } else {
                    salaryInput.value = '';
                }
            });
        }

        // Toggle
        function setupToggle(checkboxId, containerId) {
            const checkbox = document.getElementById(checkboxId);
            const container = document.getElementById(containerId);

            if (!checkbox || !container) {
                console.warn("Elemento n√£o encontrado:", checkboxId, containerId);
                return; 
            }

            function toggleVisibility() {
                if (checkbox.checked) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }

            checkbox.addEventListener('change', toggleVisibility);
            toggleVisibility();
        }

        setupToggle('id_is_foreign', 'foreign-container');
        setupToggle('id_is_pcd', 'pcd-container');
        setupToggle('id_is_cipa_member', 'cipa-container');
    });
</script>

{% endblock %}