{% extends 'global/base.html' %}

{% block title %} Cadastrar Funcion√°rio | {% endblock title %}


{% block content %}

<style>
    .history-scroll {
        /* Define a altura fixa da "janela" */
        max-height: 300px;       
        
        /* Cria a barra de rolagem se o conte√∫do estourar a altura */
        overflow-y: auto;        
        overflow-x: hidden;
        
        /* Acabamento visual */
        padding: 10px;
        border: 1px solid #e9ecef; /* Uma borda sutil para delimitar a √°rea */
        border-radius: 6px;
        background-color: #fff;
    }

    /* (Opcional) Deixar a barra de rolagem mais moderna e fina */
    .history-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .history-scroll::-webkit-scrollbar-track {
        background: #f8f9fa; 
    }
    .history-scroll::-webkit-scrollbar-thumb {
        background: #ced4da; 
        border-radius: 3px;
    }
    .history-scroll::-webkit-scrollbar-thumb:hover {
        background: #adb5bd; 
    }

    dialog.delete-dialog {
    /* Centraliza√ß√£o Absoluta */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0; /* Remove margens padr√£o que empurram pro canto */
    border: none;
    border-radius: 12px;
    padding: 30px;
    width: 320px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    z-index: 9999;
    background: #fff;
    opacity: 0; /* Come√ßa invis√≠vel para anima√ß√£o */
    }

    /* Quando aberto, fica vis√≠vel */
    dialog.delete-dialog[open] {
        animation: zoomIn 0.2s forwards;
    }

    /* Fundo escuro atr√°s */
    dialog.delete-dialog::backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
    }

    .dialog-content h3 { margin: 15px 0 5px; color: #333; font-size: 2rem; }
    .dialog-content p { color: #666; margin-bottom: 25px; font-size: 1.6rem; }

    .dialog-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    /* Bot√µes do Modal */
    .btn-cancel-modal, .btn-confirm-modal {
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        font-size: 1.4rem;
        transition: transform 0.1s;
    }

    .btn-cancel-modal {
        background: #f1f3f5;
        color: #495057;
        border: 1px solid #dee2e6;
    }
    .btn-cancel-modal:hover { background: #e9ecef; }

    .btn-confirm-modal {
        background: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    .btn-confirm-modal:hover { background: #c82333; }

    /* Bot√£o X da lista (Estilo limpo) */
    .btn-icon-delete {
        position: absolute; 
        top: 10px; 
        right: 10px; 
        border: none; 
        background: none; 
        color: #dc3545; 
        cursor: pointer; 
        font-size: 2.5rem;
        padding: 5px;
        transition: color 0.2s;
    }
    .btn-icon-delete:hover { color: #a71d2a; transform: scale(1.1); }

    .dep-title {
        font-size: 1.4rem;
    }

    @keyframes zoomIn {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
</style>

<div class="form-container">
    <h2>{{ title|default:"Cadastrar Funcion√°rio" }}</h2>

    <form method="POST" id="employeeForm" data-jobs-url="{% url 'rhcontrol:ajax_load_job_titles' %}" novalidate>
        {% csrf_token %}
        
        <div class="form-content">
            
            <h3 class="section-title">Dados Pessoais</h3>
            
            {% include 'partials/form_field.html' with field=form.name grid_class="col-span-8" %}
            {% include 'partials/form_field.html' with field=form.mother_name grid_class="col-span-8"%}
            {% include 'partials/form_field.html' with field=form.birth_date grid_class="col-span-1" %}
            
            {% include 'partials/form_field.html' with field=form.gender grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.ethnicity grid_class="col-span-1" %}

            {% include 'partials/form_field.html' with field=form.marital_status grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.birth_city grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.state_birthplace_code grid_class="col-span-1"%}
            {% include 'partials/form_field.html' with field=form.education_level grid_class="col-span-2"%}
           
            {% include 'partials/form_field.html' with field=form.email grid_class="col-span-3"%}
            <div class="col-span-2"></div>
            {% include 'partials/form_field.html' with field=form.mobile_phone grid_class="col-span-1"%}
            {% include 'partials/form_field.html' with field=form.emergency_contact_name grid_class="col-span-3"%}
            {% include 'partials/form_field.html' with field=form.emergency_phone grid_class="col-span-2" %}
            

            <h3 class="section-title">Documenta√ß√£o</h3>

            {% include 'partials/form_field.html' with field=form.cpf grid_class="col-span-1" %}
            {% include 'partials/form_field.html' with field=form.rg grid_class="col-span-1" %}
            
            {% include 'partials/form_field.html' with field=form.rg_issue_date grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.pis grid_class="col-span-2" %}
            <div class="col-span-2"></div>
            {% include 'partials/form_field.html' with field=form.ctps_number grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.ctps_series grid_class="col-span-1" %}
            
            {% include 'partials/form_field.html' with field=form.ctps_issue_date grid_class="col-span-1" %}


            <h3 class="section-title">Contato e Endere√ßo</h3>

            {% include 'partials/form_field.html' with field=form.zip_code grid_class="col-span-1" %}
            {% include 'partials/form_field.html' with field=form.address grid_class="col-span-3" %}
            {% include 'partials/form_field.html' with field=form.address_num grid_class="col-span-1"%}
            {% include 'partials/form_field.html' with field=form.complement grid_class="col-span-1" %}
            <div class="col-span-2"></div>
            {% include 'partials/form_field.html' with field=form.neighborhood grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.city grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.state_code grid_class="col-span-1" %}
            
            <h3 class="section-title">Dependentes</h3>

                {% include 'partials/form_field.html' with field=form.has_dependents grid_class="col-span-3" %}
                <div class="col-span-5"></div>

                <div id="dependents-container" class="hidden col-span-8">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                    
                    {{ dependent_formset.management_form }}

                    <div id="dependents-list">
                        {% for dep_form in dependent_formset %}
                            <div class="dependent-row" style="margin-bottom: 15px; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                                
                                {% for hidden in dep_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}

                                <div style="display: none;">
                                    {{ dep_form.DELETE }}
                                </div>

                                <div class="dep-header" onclick="toggleDependentBody(this)" style="padding: 15px; background-color: #f1f3f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fa fa-chevron-right dep-arrow" style="transition: transform 0.2s; color: #6c757d;"></i>
                                        <h4 style="margin: 0; font-size: 1.5rem; color: #495057; font-weight: 700;">
                                            <span class="dep-name-display">{{ dep_form.instance.name|default:"Novo Dependente" }}</span>
                                            <small style="font-weight: 400; color: #6c757d; margin-left: 5px;">
                                                (<span class="dep-relation-display">{{ dep_form.instance.relationship_type|default:"..." }}</span>)
                                            </small>
                                        </h4>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px;">
                                        <button type="button" class="remove-dep-btn" style="border: none; background: transparent; color: #dc3545; font-size: 1.2rem; cursor: pointer;" title="Excluir Dependente">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="dep-body" style="padding: 20px; display: none;"> <div class="form-content" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 20px;">
                                        
                                        {% include 'partials/form_field.html' with field=dep_form.name label="Nome Completo" grid_class="col-span-4" %}
                                        {% include 'partials/form_field.html' with field=dep_form.cpf label="CPF" grid_class="col-span-2" %}
                                        {% include 'partials/form_field.html' with field=dep_form.birth_date label="Data Nasc." grid_class="col-span-2" %}
                                        
                                        {% include 'partials/form_field.html' with field=dep_form.relationship_type label="V√≠nculo" grid_class="col-span-3" %}
                                        {% include 'partials/form_field.html' with field=dep_form.has_disability grid_class="col-span-5" %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-dependent-btn" style="background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                        + Adicionar Dependente
                    </button>
                </div>
            </div>

            <div id="empty-dependent-form" style="display:none;">
                <div class="dependent-row" style="margin-bottom: 15px; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                    
                    <div style="display: none;">
                        <input type="checkbox" name="dependents-__prefix__-DELETE" id="id_dependents-__prefix__-DELETE">
                    </div>

                    <div class="dep-header" onclick="toggleDependentBody(this)" style="padding: 15px; background-color: #f1f3f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fa fa-chevron-down dep-arrow" style="transition: transform 0.2s; color: #6c757d;"></i>
                            <h4 style="margin: 0; font-size: 1.5rem; color: #495057; font-weight: 700;">
                                <span class="dep-name-display">Novo Dependente</span>
                                <small style="font-weight: 400; color: #6c757d; margin-left: 5px;">
                                    (<span class="dep-relation-display">...</span>)
                                </small>
                            </h4>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="remove-dep-btn" data-new="true" style="border: none; background: transparent; color: #dc3545; font-size: 1.2rem; cursor: pointer;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="dep-body" style="padding: 20px; display: block;"> 
                        <div class="form-content" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 20px;">
                            
                            {% include 'partials/form_field.html' with field=dependent_formset.empty_form.name label="Nome Completo" grid_class="col-span-4" %}
                            {% include 'partials/form_field.html' with field=dependent_formset.empty_form.cpf label="CPF" grid_class="col-span-2" %}
                            {% include 'partials/form_field.html' with field=dependent_formset.empty_form.birth_date label="Data Nasc." grid_class="col-span-2" %}
                            
                            {% include 'partials/form_field.html' with field=dependent_formset.empty_form.relationship_type label="V√≠nculo" grid_class="col-span-3" %}
                            {% include 'partials/form_field.html' with field=dependent_formset.empty_form.has_disability grid_class="col-span-5" %}
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="section-title">Dados Banc√°rios</h3>

            {% include 'partials/form_field.html' with field=form.bank_name grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.account_type grid_class="col-span-2"%}
            
            {% include 'partials/form_field.html' with field=form.bank_agency_code grid_class="col-span-1" %}
            {% include 'partials/form_field.html' with field=form.account_num grid_class="col-span-2" %}


           <h3 class="section-title">Outras Informa√ß√µes</h3>

            {% include 'partials/form_field.html' with field=form.is_pcd grid_class="col-span-3" %}
            <div class="col-span-5"></div>

            <div id="pcd-container" class="hidden col-span-8">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; display: grid; grid-template-columns: repeat(8, 1fr); gap: 20px;">
                    
                    {% include 'partials/form_field.html' with field=form.disability_type grid_class="col-span-3" %}
                    
                </div>
            </div>

            {% include 'partials/form_field.html' with field=form.is_foreign grid_class="col-span-3" %}
            <div class="col-span-5"></div>

            <div id="foreign-container" class="hidden col-span-8">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; display: grid; grid-template-columns: repeat(8, 1fr); gap: 20px;">
                    
                    {% include 'partials/form_field.html' with field=form.arrival_date grid_class="col-span-2" %}
                    {% include 'partials/form_field.html' with field=form.naturalization_date grid_class="col-span-2" %}
                    {% include 'partials/form_field.html' with field=form.rne_number grid_class="col-span-3" %}
                    
                    {% include 'partials/form_field.html' with field=form.rne_issue_date grid_class="col-span-2" %}
                    {% include 'partials/form_field.html' with field=form.rne_issuing_authority grid_class="col-span-3" %}
                    <div class="col-span-2"></div>
                    {% include 'partials/form_field.html' with field=form.married_to_brazilian grid_class="col-span-2" %}
                    {% include 'partials/form_field.html' with field=form.has_brazilian_children grid_class="col-span-2" %}
                    
                </div>
            </div>


            {% include 'partials/form_field.html' with field=form.is_cipa_member grid_class="col-span-3" %}
            <div class="col-span-5"></div>

            <div id="cipa-container" class="hidden col-span-8">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; display: grid; grid-template-columns: repeat(8, 1fr); gap: 20px;">
                    
                    {% include 'partials/form_field.html' with field=form.cipa_role grid_class="col-span-3" %}
                    {% include 'partials/form_field.html' with field=form.cipa_mandate_start_date grid_class="col-span-2" %}
                    {% include 'partials/form_field.html' with field=form.cipa_mandate_end_date grid_class="col-span-2" %}
                    
                </div>
            </div>

            <div class="col-span-4" style="margin-top: 15px;">
                {% include 'partials/form_field.html' with field=form.retirement_status %}
            </div>

            <h3 class="section-title">Dados do Contrato</h3>

            {% include 'partials/form_field.html' with field=form.admission_exam_date grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.department grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.job_title grid_class="col-span-2"%}

            {% include 'partials/form_field.html' with field=form.current_salary is_money=True grid_class="col-span-1"%}
            {% include 'partials/form_field.html' with field=form.hire_date grid_class="col-span-2" %}

            {% include 'partials/form_field.html' with field=form.is_trial_contract grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.is_first_job grid_class="col-span-2" %}
            {% include 'partials/form_field.html' with field=form.is_intermittent_contract grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.uses_transport_voucher grid_class="col-span-2" %}
        
            {% include 'partials/form_field.html' with field=form.has_insalubrity_bonus grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.has_danger_bonus grid_class="col-span-2"%}

            {% if form.instance.pk %}
                <div class="conditional-section" style="grid-column: 1 / -1; margin-top: 30px; border-color: #ffeeba; background-color: #fff3cd;">
                    
                    <div style=" margin-bottom: 15px;">
                        <h4 style="margin:0; color:#856404; font-size: 1.6rem;">
                            <i class="fa fa-history"></i> Altera√ß√£o
                        </h4>
                        <p style="font-size:1.3rem; margin:5px 0 0 0; color: #856404;">
                            Preencha apenas se for registrar uma mudan√ßa de Cargo ou Sal√°rio.
                        </p>
                    </div>
                    <div class="col-span-2"></div>

                    {% include 'partials/form_field.html' with field=form.change_date grid_class="col-span-1" %}
                    {% include 'partials/form_field.html' with field=form.change_reason grid_class="col-span-1"%}
                    
                </div>
            {% endif %}

            <h3 class="section-title">Desligamento</h3>
            {% include 'partials/form_field.html' with field=form.termination_date grid_class="col-span-2"%}
            {% include 'partials/form_field.html' with field=form.termination_reason grid_class="col-span-6"%}

        </div>

        <div class="form-buttons">
            <button type="submit" class="btn-save">Salvar Cadastro</button>

            {% if form.instance.pk %}
                <a href="{% url 'rhcontrol:employee_delete' pk=form.instance.pk %}" class="btn-delete">
                    <i class="fa fa-trash"></i> Excluir Funcion√°rio
                </a>
            {% endif %}
        </div>
    </form>
</div>

{% if history_enabled %}
    <div class="history-container">
        
        <div class="history-header">
            <h3>Hist√≥rico do Colaborador</h3>
        </div>
        
        <div class="history-columns">
            
            <div class="history-col">
                <h4>üéì Treinamentos ({{ total_hours }}h)</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for t in trainings %}
                            <li class="history-item">
                                <strong>{{ t.training_date|date:"d/m/Y" }}</strong><br>
                                {{ t.training_name }} 
                                <span style="display:inline-block; background:#eef2ff; color:#4f46e5; padding:2px 8px; border-radius:4px; font-size:0.85em; font-weight:bold; margin-left:5px;">
                                    {{ t.training_duration }}h
                                </span>
                            </li>
                        {% empty %}
                            <li class="history-empty">Nenhum treinamento realizado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="history-col">
                <h4>üíº Evolu√ß√£o Profissional</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for h in history_log %}
                            <li class="history-item" style="position: relative;">
                                
                                <button type="button" 
                                        onclick="openDeleteModal('{% url 'rhcontrol:history_delete' pk=h.pk %}')"
                                        style="position: absolute; top: 10px; right: 10px; border: none; background: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                    <i class="fa fa-times"></i>
                                </button>

                                <div style="font-size: 1.4rem; font-weight: 800; color: #6c757d; margin-bottom: 8px; letter-spacing: 0.5px;">
                                    {{ h.date_changed|date:"d F Y"|upper }}
                                </div>

                                {% if h.reason %}
                                    <div style="margin-bottom: 12px;">
                                        <span style="display:inline-block; background:#e9ecef; color: #495057; padding: 6px 12px; border-radius: 6px; font-size: 1.2rem; font-weight: 700;">
                                            {{ h.reason }}
                                        </span>
                                    </div>
                                {% endif %}

                                {% if h.new_job_title %}
                                    <div style="margin-bottom: 6px; font-size: 1.6rem;">
                                        Cargo: 
                                        {% if h.old_job_title and h.old_job_title != "None" %}
                                            <span style="color:#666;">{{ h.old_job_title }}</span> 
                                            <i class="fa fa-arrow-right" style="font-size: 0.8em; margin: 0 5px; color: #adb5bd;"></i>
                                        {% endif %}
                                        
                                        <strong style="color: #0d6efd;">{{ h.new_job_title }}</strong>
                                    </div>
                                {% endif %}

                                {% if h.new_salary %}
                                    <div style="font-size: 1.6rem;">
                                        Sal√°rio: 
                                        {% if h.old_salary %}
                                            <span style="color:#666;">R$ {{ h.old_salary|floatformat:2 }}</span> 
                                            <i class="fa fa-arrow-right" style="font-size: 0.8em; margin: 0 5px; color: #adb5bd;"></i>
                                        {% endif %}
                                        
                                        <strong style="color:#198754;">R$ {{ h.new_salary|floatformat:2 }}</strong>
                                    </div>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="history-empty" style="padding: 20px; text-align: center; color: #999;">
                                Nenhuma altera√ß√£o registrada.
                            </li>
                        {% endfor %}
                </ul>
                </div>
            </div>

            <div class="history-col">
                <h4>üèñÔ∏è Hist√≥rico de F√©rias</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for v in vacations %}
                            <li class="history-item">
                                <strong>{{ v.start_date|date:"d/m/Y" }}</strong> at√© <strong>{{ v.end_date|date:"d/m/Y" }}</strong>
                                <br>
                                <span style="color: #6c757d; font-size: 0.95em;">Dura√ß√£o: {{ v.vacation_duration }} dias</span>
                            </li>
                        {% empty %}
                            <li class="history-empty">Nenhuma f√©rias registrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
{% endif %}

    <dialog id="deleteModal" class="delete-dialog">
        <div class="dialog-content">
            <i class="fa fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 10px;"></i>
            <h3>Excluir Registro?</h3>
            <p>Essa a√ß√£o n√£o poder√° ser desfeita.</p>
            
            <div class="dialog-actions">
                <button onclick="closeDeleteModal()" class="btn-cancel-modal">Cancelar</button>
                <a id="btnConfirmDelete" href="#" class="btn-confirm-modal">Sim, Excluir</a>
            </div>
        </div>
    </dialog>
<script src="https://unpkg.com/imask"></script>

<script>
    // --- FUN√á√ÉO GLOBAL DO ACORDE√ÉO (Fora do DOMContentLoaded para o HTML acessar) ---
    function toggleDependentBody(header) {
        const row = header.closest('.dependent-row');
        const body = row.querySelector('.dep-body');
        const arrow = row.querySelector('.dep-arrow');

        if (body.style.display === 'none') {
            body.style.display = 'block';
            arrow.classList.remove('fa-chevron-right');
            arrow.classList.add('fa-chevron-down');
        } else {
            body.style.display = 'none';
            arrow.classList.remove('fa-chevron-down');
            arrow.classList.add('fa-chevron-right');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Sistema RH: Scripts carregados.");

        // --- 1. FUN√á√ÉO DE VALIDA√á√ÉO DE CPF ---
        function isValidCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, ''); 
            if (cpf == '') return false;
            if (cpf.length != 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let add = 0;
            for (let i=0; i < 9; i ++) add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(9))) return false;
            
            add = 0;
            for (let i = 0; i < 10; i ++) add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(10))) return false;
            
            return true;
        }

        // --- 2. CONFIGURADOR DE CAMPOS (Capslock, CPF, Listeners de Cabe√ßalho) ---
        function setupFields(context) {
            // A. ATUALIZA√á√ÉO DIN√ÇMICA DO CABE√áALHO (Nome e V√≠nculo)
            const nameInput = context.querySelector('input[name$="-name"]');
            const relationInput = context.querySelector('select[name$="-relationship_type"]');
            
            if(nameInput) {
                // Ao digitar, atualiza o t√≠tulo
                nameInput.addEventListener('input', function() {
                    const row = this.closest('.dependent-row');
                    const display = row.querySelector('.dep-name-display');
                    if(display) display.textContent = this.value.toUpperCase() || "Novo Dependente";
                });
                // Capslock visual
                nameInput.style.textTransform = 'uppercase';
                nameInput.addEventListener('input', function() {
                    let start = this.selectionStart;
                    this.value = this.value.toUpperCase();
                    this.setSelectionRange(start, start);
                });
            }

            if(relationInput) {
                relationInput.addEventListener('change', function() {
                    const row = this.closest('.dependent-row');
                    const display = row.querySelector('.dep-relation-display');
                    if(display) display.textContent = this.options[this.selectedIndex].text;
                });
            }

            // B. CPF
            const cpfInputs = context.querySelectorAll('.cpf-input');
            cpfInputs.forEach(input => {
                try { if (!input.mask) IMask(input, { mask: '000.000.000-00' }); } catch(e){}

                input.addEventListener('blur', function() {
                    const errorContainer = this.parentNode.querySelector('.js-error-msg');
                    const value = this.value;
                    if (value.length > 0) {
                        if (!isValidCPF(value)) {
                            this.style.borderColor = '#dc3545';
                            if(errorContainer) {
                                errorContainer.innerHTML = '<i class="fa fa-times-circle"></i> CPF Inv√°lido.';
                                errorContainer.style.display = 'flex'; 
                            }
                        } else {
                            this.style.borderColor = '#ced4da'; 
                            if(errorContainer) errorContainer.style.display = 'none';
                        }
                    } else {
                        this.style.borderColor = '#ced4da';
                        if(errorContainer) errorContainer.style.display = 'none';
                    }
                });
                
                input.addEventListener('input', function() {
                    this.style.borderColor = '#ced4da';
                    const errorContainer = this.parentNode.querySelector('.js-error-msg');
                    if(errorContainer) errorContainer.style.display = 'none';
                });
            });
        }

        // Inicializa nos campos existentes (Roda em cada linha de dependente)
        const existingRows = document.querySelectorAll('.dependent-row');
        existingRows.forEach(row => setupFields(row));

        // --- 3. M√ÅSCARAS GERAIS ---
        const salaryInput = document.getElementById('id_current_salary');
        if (salaryInput) {
            IMask(salaryInput, {
                mask: Number, scale: 2, signed: false, thousandsSeparator: '.', padFractionalZeros: true,
                normalizeZeros: true, radix: ',', mapToRadix: ['.'], min: 0, max: 9999999999.99
            });
        }
        
        // --- 4. TOGGLES & AJAX ---
        // (Aqui entra o c√≥digo do AJAX de Setor/Cargo que fizemos na resposta anterior. 
        //  Vou omitir para n√£o ficar gigante, mas VOC√ä DEVE MANTER O AJAX DO SETOR AQUI)
        
        // ... (Cole aqui a l√≥gica do AJAX Setor/Cargo da resposta anterior) ...
        const departmentSelect = document.getElementById('id_department');
        const jobTitleSelect = document.getElementById('id_job_title');
        const formElement = document.getElementById('employeeForm');

        if (formElement && departmentSelect && jobTitleSelect) {
            const url = formElement.getAttribute('data-jobs-url');
            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                if(salaryInput) { salaryInput.value = ''; salaryInput.dispatchEvent(new Event('input')); }
                jobTitleSelect.innerHTML = '<option value="">---------</option>';
                if (!departmentId) return;
                fetch(`${url}?department_id=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = job.name;
                            const salario = job.base_salary ? job.base_salary : '';
                            option.setAttribute('data-salary', salario);
                            jobTitleSelect.appendChild(option);
                        });
                    });
            });
            jobTitleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                let baseSalary = selectedOption.getAttribute('data-salary'); 
                if (baseSalary && salaryInput) {
                    let salarioFormatado = baseSalary.toString().replace('.', ',');
                    salaryInput.value = salarioFormatado;
                    salaryInput.dispatchEvent(new Event('input'));
                }
            });
        }

        // Toggles Normais
        function setupToggle(checkboxId, containerId) {
            const checkbox = document.getElementById(checkboxId);
            const container = document.getElementById(containerId);
            if (!checkbox || !container) return;
            function toggleVisibility() {
                if (checkbox.checked) container.classList.remove('hidden');
                else container.classList.add('hidden');
            }
            checkbox.addEventListener('change', toggleVisibility);
            toggleVisibility();
        }
        setupToggle('id_is_foreign', 'foreign-container');
        setupToggle('id_is_pcd', 'pcd-container');
        setupToggle('id_is_cipa_member', 'cipa-container');
        setupToggle('id_has_dependents', 'dependents-container');

        // --- 5. L√ìGICA DE DEPENDENTES (ADD/REMOVE) ---
        const addDepBtn = document.getElementById('add-dependent-btn');
        const depContainer = document.getElementById('dependents-list');
        const totalDepForms = document.querySelector('input[name="dependents-TOTAL_FORMS"]');

        if (addDepBtn && depContainer && totalDepForms) {
            
            // BOT√ÉO ADICIONAR
            addDepBtn.addEventListener('click', function(e) {
                e.preventDefault();
                let formIdx = totalDepForms.value;
                const emptyFormContent = document.getElementById('empty-dependent-form');
                if (!emptyFormContent) return;

                // Cria o HTML
                const newDiv = document.createElement('div');
                newDiv.innerHTML = emptyFormContent.innerHTML.replace(/__prefix__/g, formIdx);
                const newRow = newDiv.firstElementChild;
                
                // Adiciona na lista
                depContainer.appendChild(newRow);
                totalDepForms.value = parseInt(formIdx) + 1;

                // Configura valida√ß√µes e ouvintes
                setupFields(newRow);
            });

            // BOT√ÉO REMOVER (X)
            depContainer.addEventListener('click', function(e) {
                const btn = e.target.closest('.remove-dep-btn');
                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const row = btn.closest('.dependent-row');
                    if (btn.dataset.new === "true") {
                        row.remove(); 
                    } else {
                        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                        if (deleteCheckbox) deleteCheckbox.checked = true;
                        row.style.display = 'none';
                    }
                }
            });
        }
    });

    function openDeleteModal(deleteUrl) {
        const dialog = document.getElementById('deleteModal');
        const confirmBtn = document.getElementById('btnConfirmDelete');
        if (dialog && confirmBtn) {
            confirmBtn.href = deleteUrl;
            dialog.showModal();
        }
    }
    function closeDeleteModal() {
        const dialog = document.getElementById('deleteModal');
        if (dialog) dialog.close();
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const cepInput = document.getElementById('id_zip_code');
        const ruaInput = document.getElementById('id_address');
        const bairroInput = document.getElementById('id_neighborhood');
        const cidadeInput = document.getElementById('id_city');
        const ufInput = document.getElementById('id_state_code');
        
        if (cepInput) IMask(cepInput, { mask: '00000-000' });

        function showCepError(msg) {
            if (!cepInput) return;
            cepInput.style.borderColor = '#dc3545';
            const errorContainer = cepInput.parentNode.querySelector('.js-error-msg');
            if (errorContainer) {
                errorContainer.innerHTML = `<i class="fa fa-times-circle"></i> ${msg}`;
                errorContainer.style.display = 'flex'; // ou block
            }
        }

        function clearCepError() {
            if (!cepInput) return;
            cepInput.style.borderColor = '#ced4da';
            const errorContainer = cepInput.parentNode.querySelector('.js-error-msg');
            if (errorContainer) errorContainer.style.display = 'none';
        }

        function limparFormulario() {
            if(ruaInput) ruaInput.value = "";
            if(bairroInput) bairroInput.value = "";
            if(cidadeInput) cidadeInput.value = "";
            if(ufInput) ufInput.value = "";
        }

        if (cepInput) {
            cepInput.addEventListener('input', clearCepError);

            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');

                if (cep !== "") {
                    const validacep = /^[0-9]{8}$/;

                    if(validacep.test(cep)) {
                        if(ruaInput) ruaInput.value = "...";
                        
                        fetch(`https://viacep.com.br/ws/${cep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!("erro" in data)) {
                                    if(ruaInput) ruaInput.value = data.logradouro;
                                    if(bairroInput) bairroInput.value = data.bairro;
                                    if(cidadeInput) cidadeInput.value = data.localidade;
                                    if(ufInput) {
                                        ufInput.value = data.uf;
                                        ufInput.dispatchEvent(new Event('change'));
                                    }
                                    const numeroInput = document.getElementById('id_address_num');
                                    if(numeroInput) numeroInput.focus();
                                    
                                    clearCepError();
                                } else {
                                    limparFormulario();
                                    showCepError("CEP n√£o encontrado.");
                                }
                            })
                            .catch(error => {
                                limparFormulario();
                                showCepError("Erro ao buscar CEP.");
                            });
                    } else {
                        limparFormulario();
                        showCepError("CEP inv√°lido.");
                    }
                } else {
                    limparFormulario();
                    clearCepError();
                }
            });
        }
    });
</script>

{% endblock %}