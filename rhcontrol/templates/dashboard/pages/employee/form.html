{% extends 'global/base.html' %}

{% block title %} Cadastrar Funcion√°rio | {% endblock title %}

{% block content %}

<style>
    .history-scroll {
        /* Define a altura fixa da "janela" */
        max-height: 300px;       
        
        /* Cria a barra de rolagem se o conte√∫do estourar a altura */
        overflow-y: auto;        
        overflow-x: hidden;
        
        /* Acabamento visual */
        padding: 10px;
        border: 1px solid #e9ecef; /* Uma borda sutil para delimitar a √°rea */
        border-radius: 6px;
        background-color: #fff;
    }

    /* (Opcional) Deixar a barra de rolagem mais moderna e fina */
    .history-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .history-scroll::-webkit-scrollbar-track {
        background: #f8f9fa; 
    }
    .history-scroll::-webkit-scrollbar-thumb {
        background: #ced4da; 
        border-radius: 3px;
    }
    .history-scroll::-webkit-scrollbar-thumb:hover {
        background: #adb5bd; 
    }

    dialog.delete-dialog {
    /* Centraliza√ß√£o Absoluta */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0; /* Remove margens padr√£o que empurram pro canto */
    border: none;
    border-radius: 12px;
    padding: 30px;
    width: 320px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    z-index: 9999;
    background: #fff;
    opacity: 0; /* Come√ßa invis√≠vel para anima√ß√£o */
    }

    /* Quando aberto, fica vis√≠vel */
    dialog.delete-dialog[open] {
        animation: zoomIn 0.2s forwards;
    }

    /* Fundo escuro atr√°s */
    dialog.delete-dialog::backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(3px);
    }

    .dialog-content h3 { margin: 15px 0 5px; color: #333; font-size: 2rem; }
    .dialog-content p { color: #666; margin-bottom: 25px; font-size: 1.6rem; }

    .dialog-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    /* Bot√µes do Modal */
    .btn-cancel-modal, .btn-confirm-modal {
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        font-size: 1.4rem;
        transition: transform 0.1s;
    }

    .btn-cancel-modal {
        background: #f1f3f5;
        color: #495057;
        border: 1px solid #dee2e6;
    }
    .btn-cancel-modal:hover { background: #e9ecef; }

    .btn-confirm-modal {
        background: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    .btn-confirm-modal:hover { background: #c82333; }

    /* Bot√£o X da lista (Estilo limpo) */
    .btn-icon-delete {
        position: absolute; 
        top: 10px; 
        right: 10px; 
        border: none; 
        background: none; 
        color: #dc3545; 
        cursor: pointer; 
        font-size: 2.5rem;
        padding: 5px;
        transition: color 0.2s;
    }
    .btn-icon-delete:hover { color: #a71d2a; transform: scale(1.1); }

    @keyframes zoomIn {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
</style>

<div class="form-container">
    <h2>{{ title|default:"Cadastrar Funcion√°rio" }}</h2>

    <form method="POST" id="employeeForm" data-jobs-url="{% url 'rhcontrol:ajax_load_job_titles' %}">
        {% csrf_token %}
        
        <div class="form-content">
            
            <h3 class="section-title">Dados Pessoais</h3>
            
            {% include 'partials/form_field.html' with field=form.name %}
            {% include 'partials/form_field.html' with field=form.birth_date %}
            
            {% include 'partials/form_field.html' with field=form.gender %}
            {% include 'partials/form_field.html' with field=form.ethnicity %}

            {% include 'partials/form_field.html' with field=form.marital_status %}
            {% include 'partials/form_field.html' with field=form.education_level %}
            {% include 'partials/form_field.html' with field=form.mother_name %}
            <div class="form-group"></div> {% include 'partials/form_field.html' with field=form.birth_city %}
            {% include 'partials/form_field.html' with field=form.state_birthplace_code %}


            <h3 class="section-title">Documenta√ß√£o</h3>

            {% include 'partials/form_field.html' with field=form.cpf %}
            {% include 'partials/form_field.html' with field=form.rg %}
            
            {% include 'partials/form_field.html' with field=form.rg_issue_date %}
            {% include 'partials/form_field.html' with field=form.pis %}
            
            {% include 'partials/form_field.html' with field=form.ctps_number %}
            {% include 'partials/form_field.html' with field=form.ctps_series %}
            
            {% include 'partials/form_field.html' with field=form.ctps_issue_date %}
            <div class="form-group"></div>


            <h3 class="section-title">Contato e Endere√ßo</h3>

            {% include 'partials/form_field.html' with field=form.email %}
            {% include 'partials/form_field.html' with field=form.mobile_phone %}

            {% include 'partials/form_field.html' with field=form.zip_code %}
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.address %}
            {% include 'partials/form_field.html' with field=form.address_num %}

            {% include 'partials/form_field.html' with field=form.complement %}
            {% include 'partials/form_field.html' with field=form.neighborhood %}

            {% include 'partials/form_field.html' with field=form.city %}
            {% include 'partials/form_field.html' with field=form.state_code %}

            {% include 'partials/form_field.html' with field=form.emergency_contact_name %}
            {% include 'partials/form_field.html' with field=form.emergency_phone %}


            <h3 class="section-title">Dados do Contrato</h3>

            {% include 'partials/form_field.html' with field=form.department %}
            {% include 'partials/form_field.html' with field=form.job_title %}

            {% include 'partials/form_field.html' with field=form.current_salary is_money=True %}
            {% include 'partials/form_field.html' with field=form.hire_date %}

            {% if form.instance.pk %}
                <div class="conditional-section" style="grid-column: 1 / -1; margin-top: 30px; border-color: #ffeeba; background-color: #fff3cd;">
                    
                    <div style="grid-column: 1/-1; margin-bottom: 15px;">
                        <h4 style="margin:0; color:#856404; font-size: 1.6rem;">
                            <i class="fa fa-history"></i> Configurar Altera√ß√£o (Opcional)
                        </h4>
                        <p style="font-size:1.3rem; margin:5px 0 0 0; color: #856404;">
                            Preencha apenas se for registrar uma mudan√ßa de Cargo ou Sal√°rio.
                        </p>
                    </div>

                    {% include 'partials/form_field.html' with field=form.change_date %}
                    {% include 'partials/form_field.html' with field=form.change_reason %}
                    
                </div>
            {% endif %}

            {% include 'partials/form_field.html' with field=form.admission_exam_date %}
            <div class="form-group"></div>
            
            {% include 'partials/form_field.html' with field=form.is_trial_contract %}
            {% include 'partials/form_field.html' with field=form.is_first_job %}
            
            {% include 'partials/form_field.html' with field=form.is_intermittent_contract %}
            {% include 'partials/form_field.html' with field=form.uses_transport_voucher %}
            
            {% include 'partials/form_field.html' with field=form.has_insalubrity_bonus %}
            {% include 'partials/form_field.html' with field=form.has_danger_bonus %}


            <h3 class="section-title">Dados Banc√°rios</h3>

            {% include 'partials/form_field.html' with field=form.bank_name %}
            {% include 'partials/form_field.html' with field=form.account_type %}
            
            {% include 'partials/form_field.html' with field=form.bank_agency_code %}
            {% include 'partials/form_field.html' with field=form.account_num %}


            <h3 class="section-title">Informa√ß√µes de Estrangeiro</h3>
            
            {% include 'partials/form_field.html' with field=form.is_foreign %}
            <div class="form-group"></div>

            <div id="foreign-container" class="conditional-section hidden">
                {% include 'partials/form_field.html' with field=form.arrival_date %}
                {% include 'partials/form_field.html' with field=form.naturalization_date %}
                
                {% include 'partials/form_field.html' with field=form.rne_number %}
                {% include 'partials/form_field.html' with field=form.rne_issue_date %}
                
                {% include 'partials/form_field.html' with field=form.rne_issuing_authority %}
                <div class="form-group"></div>
                
                {% include 'partials/form_field.html' with field=form.married_to_brazilian %}
                {% include 'partials/form_field.html' with field=form.has_brazilian_children %}
            </div>


            <h3 class="section-title">Outras Informa√ß√µes</h3>

            {% include 'partials/form_field.html' with field=form.is_pcd %}
            
            <div id="pcd-container" class="conditional-section hidden" style="display: block;">
                {% include 'partials/form_field.html' with field=form.disability_type %}
            </div>
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.retirement_status %}
            <div class="form-group"></div>

            {% include 'partials/form_field.html' with field=form.is_cipa_member %}
            <div class="form-group"></div>

            <div id="cipa-container" class="conditional-section hidden">
                {% include 'partials/form_field.html' with field=form.cipa_role %}
                <div class="form-group"></div>
                
                {% include 'partials/form_field.html' with field=form.cipa_mandate_start_date %}
                {% include 'partials/form_field.html' with field=form.cipa_mandate_end_date %}
            </div>

            <h3 class="section-title">Desligamento</h3>
            {% include 'partials/form_field.html' with field=form.termination_date %}
            {% include 'partials/form_field.html' with field=form.termination_reason %}

        </div>

        <div class="form-buttons">
            <button type="submit" class="btn-save">Salvar Cadastro</button>

            {% if form.instance.pk %}
                <a href="{% url 'rhcontrol:employee_delete' pk=form.instance.pk %}" class="btn-delete">
                    <i class="fa fa-trash"></i> Excluir Funcion√°rio
                </a>
            {% endif %}
        </div>
    </form>
</div>

{% if history_enabled %}
    <div class="history-container">
        
        <div class="history-header">
            <h3>Hist√≥rico do Colaborador</h3>
        </div>
        
        <div class="history-columns">
            
            <div class="history-col">
                <h4>üéì Treinamentos ({{ total_hours }}h)</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for t in trainings %}
                            <li class="history-item">
                                <strong>{{ t.training_date|date:"d/m/Y" }}</strong><br>
                                {{ t.training_name }} 
                                <span style="display:inline-block; background:#eef2ff; color:#4f46e5; padding:2px 8px; border-radius:4px; font-size:0.85em; font-weight:bold; margin-left:5px;">
                                    {{ t.training_duration }}h
                                </span>
                            </li>
                        {% empty %}
                            <li class="history-empty">Nenhum treinamento realizado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="history-col">
                <h4>üíº Evolu√ß√£o Profissional</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for h in history_log %}
                            <li class="history-item" style="position: relative;">
                                <button type="button" 
                                        onclick="openDeleteModal('{% url 'rhcontrol:history_delete' pk=h.pk %}')"
                                        style="position: absolute; top: 10px; right: 10px; border: none; background: none; color: #dc3545; cursor: pointer; font-size: 1.2rem;">
                                    <i class="fa fa-times"></i>
                                </button>

                                <small>{{ h.date_changed|date:"d F Y" }}</small>

                                {% if h.reason %}
                                    <span style="display:inline-block; background:#e9ecef; padding:2px 8px; border-radius:4px; font-size:1.2rem; margin-bottom:5px; font-weight:bold;">
                                        {{ h.reason }}
                                    </span>
                                {% endif %}

                                {% if h.old_job_title != h.new_job_title %}
                                    <div style="margin-bottom:4px;">
                                        Cargo: <span style="color:#666;">{{ h.old_job_title }}</span> ‚ûù <strong>{{ h.new_job_title }}</strong>
                                    </div>
                                {% endif %}
                                {% if h.old_salary %}
                                    <div>
                                        Sal√°rio: <span style="color:#666;">R$ {{ h.old_salary }}</span> ‚ûù <strong style="color:#198754;">R$ {{ h.new_salary }}</strong>
                                    </div>
                                {% endif %}
                            </li>
                        {% empty %}
                            <li class="history-empty">Nenhuma altera√ß√£o registrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="history-col">
                <h4>üèñÔ∏è Hist√≥rico de F√©rias</h4>
                <div class="history-scroll">
                    <ul class="history-list">
                        {% for v in vacations %}
                            <li class="history-item">
                                <strong>{{ v.start_date|date:"d/m/Y" }}</strong> at√© <strong>{{ v.end_date|date:"d/m/Y" }}</strong>
                                <br>
                                <span style="color: #6c757d; font-size: 0.95em;">Dura√ß√£o: {{ v.vacation_duration }} dias</span>
                            </li>
                        {% empty %}
                            <li class="history-empty">Nenhuma f√©rias registrada.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
{% endif %}

    <dialog id="deleteModal" class="delete-dialog">
        <div class="dialog-content">
            <i class="fa fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 10px;"></i>
            <h3>Excluir Registro?</h3>
            <p>Essa a√ß√£o n√£o poder√° ser desfeita.</p>
            
            <div class="dialog-actions">
                <button onclick="closeDeleteModal()" class="btn-cancel-modal">Cancelar</button>
                <a id="btnConfirmDelete" href="#" class="btn-confirm-modal">Sim, Excluir</a>
            </div>
        </div>
    </dialog>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Script carregado!");

        const departmentSelect = document.getElementById('id_department');
        const jobTitleSelect = document.getElementById('id_job_title');
        const salaryInput = document.getElementById('id_current_salary');
        const formElement = document.getElementById('employeeForm');
        const url = formElement.getAttribute('data-jobs-url');

        if (formElement) {
            const url = formElement.getAttribute('data-jobs-url');

            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                salaryInput.value = '';

                if (!departmentId) {
                    jobTitleSelect.innerHTML = '<option value="">---------</option>';
                    return;
                }

                fetch(`${url}?department_id=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        jobTitleSelect.innerHTML = '<option value="">---------</option>';
                        data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = job.name;
                            const salario = job.base_salary ? job.base_salary : (job.salary ? job.salary : '');
                            option.setAttribute('data-salary', salario);
                            jobTitleSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro:', error));
            });

            jobTitleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const baseSalary = selectedOption.getAttribute('data-salary');
                if (baseSalary) {
                    salaryInput.value = baseSalary;
                } else {
                    salaryInput.value = '';
                }
            });
        }

        const initialDept = departmentSelect.value;
        const initialJob = jobTitleSelect.value;
        
        if (initialDept && initialJob) {
            
            fetch(`${url}?department_id=${initialDept}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(job => {
                        for (let i = 0; i < jobTitleSelect.options.length; i++) {
                            if (jobTitleSelect.options[i].value == job.id) {
                                const salario = job.base_salary ? job.base_salary : '';
                                jobTitleSelect.options[i].setAttribute('data-salary', salario);
                                break;
                            }
                        }
                    });
                });
        }

        // Toggle
        function setupToggle(checkboxId, containerId) {
            const checkbox = document.getElementById(checkboxId);
            const container = document.getElementById(containerId);

            if (!checkbox || !container) {
                console.warn("Elemento n√£o encontrado:", checkboxId, containerId);
                return; 
            }

            function toggleVisibility() {
                if (checkbox.checked) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }

            checkbox.addEventListener('change', toggleVisibility);
            toggleVisibility();
        }

        setupToggle('id_is_foreign', 'foreign-container');
        setupToggle('id_is_pcd', 'pcd-container');
        setupToggle('id_is_cipa_member', 'cipa-container');
    });

    function openDeleteModal(deleteUrl) {
    const dialog = document.getElementById('deleteModal');
    const confirmBtn = document.getElementById('btnConfirmDelete');
    
    if (dialog && confirmBtn) {
        confirmBtn.href = deleteUrl; // Define o link de deletar no bot√£o "Sim"
        dialog.showModal(); // Abre centralizado com fundo escuro
    } else {
        console.error("Modal ou Bot√£o n√£o encontrados!");
    }
    }

    function closeDeleteModal() {
        const dialog = document.getElementById('deleteModal');
        if (dialog) dialog.close();
    }
</script>

{% endblock %}