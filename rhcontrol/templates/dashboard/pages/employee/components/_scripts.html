<script src="https://cdnjs.cloudflare.com/ajax/libs/imask/7.1.3/imask.min.js"></script>

<script>
    // --- FUNÇÃO GLOBAL DO ACORDEÃO ---
    function toggleDependentBody(header) {
        const row = header.closest('.dependent-row');
        const body = row.querySelector('.dep-body');
        const arrow = row.querySelector('.dep-arrow');

        if (body.style.display === 'none') {
            body.style.display = 'block';
            arrow.classList.remove('fa-chevron-right');
            arrow.classList.add('fa-chevron-down');
        } else {
            body.style.display = 'none';
            arrow.classList.remove('fa-chevron-down');
            arrow.classList.add('fa-chevron-right');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Sistema RH: Inicializando Scripts...");

        // VERIFICAÇÃO DE SEGURANÇA: A biblioteca carregou?
        if (typeof IMask === 'undefined') {
            console.error("ERRO CRÍTICO: A biblioteca IMask não foi carregada. Verifique sua conexão com a internet.");
            return; // Para o script para não gerar mais erros
        }

        // --- 1. FUNÇÃO DE VALIDAÇÃO DE CPF ---
        function isValidCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, ''); 
            if (cpf == '') return false;
            if (cpf.length != 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let add = 0;
            for (let i=0; i < 9; i ++) add += parseInt(cpf.charAt(i)) * (10 - i);
            let rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(9))) return false;
            
            add = 0;
            for (let i = 0; i < 10; i ++) add += parseInt(cpf.charAt(i)) * (11 - i);
            rev = 11 - (add % 11);
            if (rev == 10 || rev == 11) rev = 0;
            if (rev != parseInt(cpf.charAt(10))) return false;
            
            return true;
        }

        // --- 2. CONFIGURADOR DE CAMPOS ---
        function setupFields(context) {
            
            // A. CAPSLOCK E HEADER DINÂMICO DE DEPENDENTES
            const nameInput = context.querySelector('input[name$="-name"]'); 
            const relationInput = context.querySelector('select[name$="-relationship_type"]'); 
            
            if(nameInput) {
                nameInput.addEventListener('input', function() {
                    const row = this.closest('.dependent-row');
                    const display = row.querySelector('.dep-name-display');
                    if(display) display.textContent = this.value.toUpperCase() || "Novo Dependente";
                });
            }
            if(relationInput) {
                relationInput.addEventListener('change', function() {
                    const row = this.closest('.dependent-row');
                    const display = row.querySelector('.dep-relation-display');
                    if(display) display.textContent = this.options[this.selectedIndex].text;
                });
            }

            // APLICA CAPSLOCK GERAL
            const upperInputs = context.querySelectorAll('.uppercase-input');
            upperInputs.forEach(input => {
                input.style.textTransform = 'uppercase';
                input.addEventListener('input', function() {
                    let start = this.selectionStart;
                    this.value = this.value.toUpperCase();
                    this.setSelectionRange(start, start);
                });
            });

            // B. MÁSCARA CPF (Busca pela classe .cpf-input)
            const cpfInputs = context.querySelectorAll('.cpf-input');
            cpfInputs.forEach(input => {
                // Aplica a máscara
                try { 
                    IMask(input, { mask: '000.000.000-00' }); 
                } catch(e) { console.error("Erro ao aplicar máscara CPF:", e); }

                // Validação visual (Borda vermelha)
                input.addEventListener('blur', function() {
                    const errorContainer = this.parentNode.querySelector('.js-error-msg');
                    const value = this.value;
                    if (value.length > 0) {
                        if (!isValidCPF(value)) {
                            this.style.borderColor = '#dc3545';
                            if(errorContainer) {
                                errorContainer.innerHTML = '<i class="fa fa-times-circle"></i> CPF Inválido.';
                                errorContainer.style.display = 'flex'; 
                            }
                        } else {
                            this.style.borderColor = '#ced4da'; 
                            if(errorContainer) errorContainer.style.display = 'none';
                        }
                    } else {
                        this.style.borderColor = '#ced4da';
                        if(errorContainer) errorContainer.style.display = 'none';
                    }
                });
                
                // Limpa erro ao digitar
                input.addEventListener('input', function() {
                    this.style.borderColor = '#ced4da';
                    const errorContainer = this.parentNode.querySelector('.js-error-msg');
                    if(errorContainer) errorContainer.style.display = 'none';
                });
            });

            // C. MÁSCARA TELEFONE (Busca pela classe .phone-input)
            const phoneInputs = context.querySelectorAll('.phone-input, #id_mobile_phone, #id_emergency_phone, #id_phone');
            
            phoneInputs.forEach(input => {
                 try { 
                     if (input.mask) return;

                     IMask(input, { 
                         mask: [
                             { mask: '(00) 0000-0000' },   // Fixo
                             { mask: '(00) 00000-0000' }   // Celular
                         ] 
                     }); 
                 } catch(e){ console.error("Erro ao aplicar máscara Telefone:", e); }
            });
        }

        // --- INICIALIZAÇÃO ---
        // 1. Aplica no documento inteiro (Para o Funcionário Principal)
        setupFields(document);

        // 2. Aplica nos dependentes já existentes
        const existingRows = document.querySelectorAll('.dependent-row');
        existingRows.forEach(row => setupFields(row));

        // --- 3. MÁSCARA SALÁRIO ---
        const salaryInput = document.getElementById('id_current_salary');
        if (salaryInput) {
            try {
                IMask(salaryInput, {
                    mask: Number, scale: 2, signed: false, thousandsSeparator: '.', padFractionalZeros: true,
                    normalizeZeros: true, radix: ',', mapToRadix: ['.'], min: 0, max: 9999999999.99
                });
            } catch(e) { console.error("Erro máscara salário:", e); }
        }
        
        // --- 4. AJAX (CARGOS E SALÁRIOS) ---
        const departmentSelect = document.getElementById('id_department');
        const jobTitleSelect = document.getElementById('id_job_title');
        const formElement = document.getElementById('employeeForm');

        if (formElement && departmentSelect && jobTitleSelect) {
            const url = formElement.getAttribute('data-jobs-url');
            
            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                if(salaryInput) { salaryInput.value = ''; salaryInput.dispatchEvent(new Event('input')); }
                jobTitleSelect.innerHTML = '<option value="">---------</option>';
                
                if (!departmentId) return;
                
                fetch(`${url}?department_id=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = job.name;
                            const salario = job.base_salary ? job.base_salary : '';
                            option.setAttribute('data-salary', salario);
                            jobTitleSelect.appendChild(option);
                        });
                    })
                    .catch(err => console.error("Erro AJAX Setor:", err));
            });

            jobTitleSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                let baseSalary = selectedOption.getAttribute('data-salary'); 
                if (baseSalary && salaryInput) {
                    let salarioFormatado = baseSalary.toString().replace('.', ',');
                    salaryInput.value = salarioFormatado;
                    salaryInput.dispatchEvent(new Event('input'));
                }
            });
        }

        // --- 5. TOGGLES ---
        function setupToggle(checkboxId, containerId) {
            const checkbox = document.getElementById(checkboxId);
            const container = document.getElementById(containerId);
            if (!checkbox || !container) return;
            function toggleVisibility() {
                if (checkbox.checked) container.classList.remove('hidden');
                else container.classList.add('hidden');
            }
            checkbox.addEventListener('change', toggleVisibility);
            toggleVisibility();
        }
        setupToggle('id_is_foreign', 'foreign-container');
        setupToggle('id_is_pcd', 'pcd-container');
        setupToggle('id_is_cipa_member', 'cipa-container');
        setupToggle('id_has_dependents', 'dependents-container');

        // --- 6. DEPENDENTES (ADICIONAR/REMOVER) ---
        const addDepBtn = document.getElementById('add-dependent-btn');
        const depContainer = document.getElementById('dependents-list');
        const totalDepForms = document.querySelector('input[name="dependents-TOTAL_FORMS"]');

        if (addDepBtn && depContainer && totalDepForms) {
            
            // BOTÃO ADICIONAR
            addDepBtn.addEventListener('click', function(e) {
                e.preventDefault();
                let formIdx = totalDepForms.value;
                const emptyFormContent = document.getElementById('empty-dependent-form');
                if (!emptyFormContent) return;

                const newDiv = document.createElement('div');
                newDiv.innerHTML = emptyFormContent.innerHTML.replace(/__prefix__/g, formIdx);
                const newRow = newDiv.firstElementChild;
                
                depContainer.appendChild(newRow);
                totalDepForms.value = parseInt(formIdx) + 1;

                setupFields(newRow); // Aplica máscaras no novo dependente
            });

            // BOTÃO REMOVER
            depContainer.addEventListener('click', function(e) {
                const btn = e.target.closest('.remove-dep-btn');
                if (btn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const row = btn.closest('.dependent-row');
                    if (btn.dataset.new === "true") {
                        row.remove(); 
                    } else {
                        const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                        if (deleteCheckbox) deleteCheckbox.checked = true;
                        row.style.display = 'none';
                    }
                }
            });
        }
    });

    // --- FUNÇÕES MODAL DE EXCLUSÃO ---
    function openDeleteModal(deleteUrl) {
        const dialog = document.getElementById('deleteModal');
        const confirmBtn = document.getElementById('btnConfirmDelete');
        if (dialog && confirmBtn) {
            confirmBtn.href = deleteUrl;
            dialog.showModal();
        }
    }
    function closeDeleteModal() {
        const dialog = document.getElementById('deleteModal');
        if (dialog) dialog.close();
    }
</script>

<script>
    // --- SCRIPT DE CEP ---
    document.addEventListener('DOMContentLoaded', function() {
        const cepInput = document.getElementById('id_zip_code');
        const ruaInput = document.getElementById('id_address');
        const bairroInput = document.getElementById('id_neighborhood');
        const cidadeInput = document.getElementById('id_city');
        const ufInput = document.getElementById('id_state_code');
        
        // Verifica se IMask existe antes de usar
        if (cepInput && typeof IMask !== 'undefined') {
             IMask(cepInput, { mask: '00000-000' });
        }

        function showCepError(msg) {
            if (!cepInput) return;
            cepInput.style.borderColor = '#dc3545';
            const errorContainer = cepInput.parentNode.querySelector('.js-error-msg');
            if (errorContainer) {
                errorContainer.innerHTML = `<i class="fa fa-times-circle"></i> ${msg}`;
                errorContainer.style.display = 'flex';
            }
        }

        function clearCepError() {
            if (!cepInput) return;
            cepInput.style.borderColor = '#ced4da';
            const errorContainer = cepInput.parentNode.querySelector('.js-error-msg');
            if (errorContainer) errorContainer.style.display = 'none';
        }

        function limparFormulario() {
            if(ruaInput) ruaInput.value = "";
            if(bairroInput) bairroInput.value = "";
            if(cidadeInput) cidadeInput.value = "";
            if(ufInput) ufInput.value = "";
        }

        if (cepInput) {
            cepInput.addEventListener('input', clearCepError);

            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');

                if (cep !== "") {
                    const validacep = /^[0-9]{8}$/;

                    if(validacep.test(cep)) {
                        if(ruaInput) ruaInput.value = "...";
                        
                        fetch(`https://viacep.com.br/ws/${cep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!("erro" in data)) {
                                    if(ruaInput) ruaInput.value = data.logradouro;
                                    if(bairroInput) bairroInput.value = data.bairro;
                                    if(cidadeInput) cidadeInput.value = data.localidade;
                                    if(ufInput) {
                                        ufInput.value = data.uf;
                                        ufInput.dispatchEvent(new Event('change'));
                                    }
                                    const numeroInput = document.getElementById('id_address_num');
                                    if(numeroInput) numeroInput.focus();
                                    
                                    clearCepError();
                                } else {
                                    limparFormulario();
                                    showCepError("CEP não encontrado.");
                                }
                            })
                            .catch(error => {
                                limparFormulario();
                                showCepError("Erro ao buscar CEP.");
                            });
                    } else {
                        limparFormulario();
                        showCepError("CEP inválido.");
                    }
                } else {
                    limparFormulario();
                    clearCepError();
                }
            });
        }
    });
</script>